<div class="perfil-page">
    <div class="perfil-decorative-banner"></div>
    <div class="perfil-container">
        <div class="perfil-grid">
            <aside class="perfil-card">
                <div class="perfil-avatar-section">
                    <div class="product-image">
                        <% if (typeof lista !== "undefined" && lista && lista.pro_imagem) { %>
                            <img src="<%= lista.pro_imagem %>" alt="Imagem do Produto" id="proImagemPreview">
                        <% } else { %>
                            <img src="/img/default_product.jpg" alt="Imagem do Produto" id="proImagemPreview">
                        <% } %>
                    </div>
                    <button type="button" class="perfil-change-photo" id="btnTrocarFoto">
                        Alterar imagem
                    </button>
                    <input type="file" id="prodimgInput" name="proImagem" accept="image/*" hidden>
                </div>

                <div class="perfil-info-list">
                    <div class="perfil-info-item">
                        <span class="perfil-info-label">ID do Produto</span>
                        <div class="perfil-info-value"><%= lista.pro_id %></div>
                    </div>

                    <div class="perfil-info-item">
                        <span class="perfil-info-label">Nome do Produto</span>
                        <div class="perfil-info-value"><%= lista.pro_nome %></div>
                    </div>

                    <div class="perfil-info-item">
                        <span class="perfil-info-label">Status</span>
                        <div class="perfil-info-value">
                            <% if(lista.pro_status === true) { %>
                                <span class="productAtivo" style=" display: flex; align-items: center; text-align: center; height: 30px; justify-content: center;">ATIVO</span>
                            <% } else { %>
                                <span class="productInativo" style=" display: flex; align-items: center; text-align: center; height: 30px; justify-content: center;">INATIVO</span>
                            <% } %>
                        </div>
                    </div>

                    <div class="perfil-info-item">
                        <span class="perfil-info-label">Categoria</span>
                        <div class="perfil-info-value"><%= lista.cat_nome %></div>
                    </div>
                </div>

                <a href="/dashboard" class="perfil-back-button">
                    ← Voltar ao Dashboard
                </a>
            </aside>

            <main class="perfil-card">
                <div class="perfil-header">
                    <h1 class="perfil-title">Editar Produto</h1>
                    <p class="perfil-subtitle">Atualize as informações do produto.</p>
                </div>

                <div class="perfil-form">
                    <div class="perfil-form-row">
                        <div class="perfil-form-group">
                            <label for="proNome" class="perfil-form-label">Nome do Produto</label>
                            <input
                                type="text"
                                id="nome"
                                name="proNome"
                                class="perfil-form-control"
                                placeholder="Nome do produto"
                                value="<%= lista.pro_nome %>"
                            >
                        </div>

                        <div class="perfil-form-group">
                            <label for="proPreco" class="perfil-form-label">Preço</label>
                            <input
                                type="text"
                                step="0.01"
                                id="preco"
                                name="proPreco"
                                class="perfil-form-control"
                                placeholder="0.00"
                                value="<%= Number(lista.pro_preco).toFixed(2).replace('.', ',') %>"
                                onkeyup="maskMoney(event)"
                                maxlength="11"
                            >
                        </div>
                    </div>

                    <div class="perfil-form-row">
                        <div class="perfil-form-group">
                            <label for="proCodigoBarras" class="perfil-form-label">Código de Barras</label>
                            <input
                                type="text"
                                id="codigoBarras"
                                name="proCodigoBarras"
                                class="perfil-form-control"
                                placeholder="Código de barras"
                                value="<%= lista.pro_codigo_barras %>"
                            >
                        </div>

                        <div class="perfil-form-group">
                            <label for="proEstoque" class="perfil-form-label">Estoque</label>
                            <input
                                type="number" 
                                id="estoque"
                                name="proEstoque"
                                class="perfil-form-control"
                                placeholder="Quantidade em estoque"
                                value="<%= listaEstoque.est_quantidade %>"
                            >
                        </div>
                    </div>

                    <div class="perfil-form-row">
                        <div class="perfil-form-group">
                            <label for="estoque" class="perfil-form-label">
                                Estoque Minimo
                            </label>
                            <input
                                type="number"
                                id="estoqueMin"
                                name="estoqueMin"
                                class="perfil-form-control"
                                placeholder="Estoque minimo"
                                min="0"
                                value="<%= listaEstoque.est_minimo %>"
                            >
                        </div>
                        
                        <div class="perfil-form-group">
                            <label for="proStatus" class="perfil-form-label">Status</label>
                            <select id="status" name="proStatus" class="perfil-form-control">
                                <option value="ativo" <%= lista.pro_status === true ? "selected" : "" %>>Ativo</option>
                                <option value="inativo" <%= lista.pro_status === false ? "selected" : "" %>>Inativo</option>
                            </select>
                        </div>
                    </div>

                    <div class="perfil-form-row">
                        <div class="perfil-form-group">
                            <label for="categoria" class="perfil-form-label">Categoria</label>
                            <select 
                                name="categoria" 
                                id="categoria"
                                class="perfil-form-control"
                            >
                                <option value="<%= lista.cat_id %>" selected><%= lista.cat_nome %></option>
                                <% for(let i = 0; i < listaCat.length; i++) { %>
                                    <option value="<%= listaCat[i].catID %>"><%= listaCat[i].catNome %></option>
                                <% } %>
                            </select>
                        </div>

                        <div class="perfil-form-group">
                            <label for="subcategoria" class="perfil-form-label">
                                Subcategoria
                            </label>
                            <select id="subcategoria" name="subcategoria" class="perfil-form-control">
                                <% for(let i = 0; i < listaSubcateg.length; i++) { %>
                                    <% if(lista.cat_id === listaSubcateg[i].catID) { %>
                                        <option value="<%= listaSubcateg[i].subID %>"><%= listaSubcateg[i].subNome %></option>
                                    <% } %>
                                <% } %>
                            </select>
                        </div>
                    </div>

                    <div class="perfil-form-row">
                        <div class="perfil-form-group" style="grid-column: 1 / -1;">
                            <label for="proDescricao" class="perfil-form-label">Descrição</label>
                            <textarea
                                id="descricao"
                                name="proDescricao"
                                class="perfil-form-control"
                                placeholder="Descrição do produto"
                                rows="4"
                                style="resize: vertical;"
                            ><%= lista.pro_descricao %></textarea>
                        </div>
                    </div>

                    <div class="perfil-actions">
                        <button class="btn btn-primary-soft" id="salvarAlteracaoProdutos">
                            Salvar Alterações
                        </button>
                        <button class="btn btn-outline-danger-soft btnDeletarServices" data-delete-product-service="<%= lista.proID %>">
                            Excluir Produto
                        </button>
                    </div>
                </div>
            </main>
        </div>
    </div>
    <script type="application/json" id="data-subcats">
        <%- JSON.stringify(listaSubcateg) %>
    </script>
</div>


<script>
    const btnTrocarFoto = document.getElementById("btnTrocarFoto");
    const prodimgInput = document.getElementById("prodimgInput");
    const proImagemPreview = document.getElementById("proImagemPreview");

    btnTrocarFoto.addEventListener("click", () => prodimgInput.click());

    prodimgInput.addEventListener("change", () => {
        const file = prodimgInput.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = e => {
            proImagemPreview.src = e.target.result;
        };
        reader.readAsDataURL(file);
    });

    function maskMoney(e) {
        if (document.activeElement !== e.target) return;

        let input = e.target;
        let value = input.value.replace(/\D/g, '');

        if (!value) {
            input.value = '0,00';
            return;
        }

        value = (parseInt(value, 10) / 100).toFixed(2);
        value = value.replace('.', ',');
        value = value.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
        input.value = value;
    }
</script>
